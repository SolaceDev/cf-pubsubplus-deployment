name: solace_messaging
releases:
- name: docker
  version: latest
- name: &solace_vmr_release_name solace-vmr
  version: latest
- name: solace-messaging
  version: latest
- name: on-demand-service-broker
  version: latest
- name: ((service_adapter_release))
  version: ((service_adapter_version))
- name: routing
  version: latest
- name: loggregator
  version: latest
- name: consul
  version: latest
update:
  canaries: 1
  canary_watch_time: 30000-240000
  max_in_flight: 1
  update_watch_time: 30000-600000
  serial: false
stemcells:
- alias: default
  os: ubuntu-trusty
  version: ((bosh_stemcell_version))
instance_groups:
- name: Shared-VMR
  stemcell: default
  instances: 0
  vm_type: solace.medium
  azs:
  - z1
  - z2
  - z3
  networks:
  - name: default
  persistent_disk: 20480
  jobs:
  - name: docker
    release: docker
    consumes: {}
  - name: prepare_vmr
    release: solace-vmr
    consumes: {}
  - name: containers
    release: solace-vmr
    consumes: {}
    provides:
      vmr_instance: { as: shared_vmr_list }
  - name: vmr_agent
    release: solace-vmr
    consumes: {}
  - name: route_registrar
    release: solace-vmr
    consumes:
      nats_link:
        from: nats
        deployment: ((cf_deployment))
  - name: route_registrar_active
    release: solace-vmr
    consumes:
      nats_link:
        from: nats
        deployment: ((cf_deployment))
  properties:
    admin_password: ((vmr_admin_password))
    admin_user: admin
    application_access_auth_scheme:
      value: vmr_internal
    broker_hostname: solace-messaging.((app_domain))
    broker_password: ((solace_broker_password))
    broker_user: ((solace_broker_user))
    cf_api_host: api.((system_domain))
    cf_client_id: ((solace_router_client_id))
    cf_client_secret: ((solace_router_client_secret))
    cf_organization: ((solace_broker_cf_organization))
    cf_space: ((solace_broker_cf_space))
    containers:
    - dockerfile: |2-
                  FROM solace-app:latest

                  RUN \
                    echo '#!/bin/bash' > /sbin/dhclient && \
                    echo 'exit 0' >> /sbin/dhclient && \
                    echo '3a:40:d5:42:f4:86' > /usr/sw/.nodeIdentifyingMacAddr && \
                    chmod +x /sbin/dhclient
      env_vars:
      - NODE_TYPE=MESSAGE_ROUTING_NODE
      - SERVICE_SSH_PORT=2222
      - SYSTEM_SCALING_MAXCONNECTIONCOUNT=1000
      - USERNAME_ADMIN_GLOBALACCESSLEVEL=admin
      - USERNAME_ADMIN_PASSWORD=((vmr_admin_password))
      image: solace-bosh
      name: solace
      net: host
      privileged: true
      shm_size: 2G
      uts: host
      volumes:
      - /var/vcap/store/prepare_vmr/volumes/jail:/usr/sw/jail
      - /var/vcap/store/prepare_vmr/volumes/var:/usr/sw/var
      - /var/vcap/store/prepare_vmr/volumes/internalSpool:/usr/sw/internalSpool
      - /var/vcap/store/prepare_vmr/volumes/adbBackup:/usr/sw/adb
      - /var/vcap/store/prepare_vmr/volumes/adb:/usr/sw/internalSpool/softAdb
    edition: ((vmr_edition))
    heartbeat_rate: 15000
    ldap_config:
      value: disabled
    management_access_auth_scheme:
      value: vmr_internal
    pool_name: Shared-VMR
    plan:
      limit:
        maxVpns: 5
        credentialsPerVpn: 100
        maxConnections: 200
        maxRestConnections: 200
        maxSubscriptions: 100000
        maxTransactedSessions: 200
        maxTransactions: 1000
        maxEndpoints: 200
    semp_port: 8080
    semp_ssl_port: 943
    ssh_port: 2222
    starting_port: ((starting_port))
    syslog_config:
      value: disabled
    system_domain: ((system_domain))
    tcp_routes_config:
      selected_option:
        tcp_route_enabled: not_allowed
      value: disabled
    tcp_routes_enabled: disabled
    tls_config:
      value: disabled
    vmr_agent_port: 18080
    vmr_debug_logs: disabled
- name: Community-VMR
  stemcell: default
  instances: 1
  vm_type: solace.medium
  azs:
  - z1
  - z2
  - z3
  networks:
  - name: default
  persistent_disk: 20480
  properties:
    admin_password: ((vmr_admin_password))
    admin_user: admin
    application_access_auth_scheme:
      value: vmr_internal
    broker_hostname: solace-messaging.((app_domain))
    broker_password: ((solace_broker_password))
    broker_user: ((solace_broker_user))
    cf_api_host: api.((system_domain))
    cf_client_id: ((solace_router_client_id))
    cf_client_secret: ((solace_router_client_secret))
    cf_organization: ((solace_broker_cf_organization))
    cf_space: ((solace_broker_cf_space))
    containers:
    - dockerfile: |2-
                  FROM solace-app:latest

                  RUN \
                    echo '#!/bin/bash' > /sbin/dhclient && \
                    echo 'exit 0' >> /sbin/dhclient && \
                    echo '3a:40:d5:42:f4:86' > /usr/sw/.nodeIdentifyingMacAddr && \
                    chmod +x /sbin/dhclient
      env_vars:
      - NODE_TYPE=MESSAGE_ROUTING_NODE
      - SERVICE_SSH_PORT=2222
      - SYSTEM_SCALING_MAXCONNECTIONCOUNT=100
      - USERNAME_ADMIN_GLOBALACCESSLEVEL=admin
      - USERNAME_ADMIN_PASSWORD=((vmr_admin_password))
      image: solace-bosh
      name: solace
      net: host
      privileged: true
      shm_size: 2G
      uts: host
      volumes:
      - /var/vcap/store/prepare_vmr/volumes/jail:/usr/sw/jail
      - /var/vcap/store/prepare_vmr/volumes/var:/usr/sw/var
      - /var/vcap/store/prepare_vmr/volumes/internalSpool:/usr/sw/internalSpool
      - /var/vcap/store/prepare_vmr/volumes/adbBackup:/usr/sw/adb
      - /var/vcap/store/prepare_vmr/volumes/adb:/usr/sw/internalSpool/softAdb
    edition: ((vmr_edition))
    heartbeat_rate: 15000
    ldap_config:
      value: disabled
    management_access_auth_scheme:
      value: vmr_internal
    pool_name: Community-VMR
    plan:
      limit:
        maxVpns: 1
        credentialsPerVpn: 90
        maxConnections: 100
        maxRestConnections: 100
        maxSubscriptions: 500000
        maxTransactedSessions: 100 
        maxTransactions: 500
        maxEndpoints: 100
    semp_port: 8080
    semp_ssl_port: 943
    ssh_port: 2222
    starting_port: ((starting_port))
    syslog_config:
      value: disabled
    system_domain: ((system_domain))
    tcp_routes_config:
      selected_option:
        tcp_route_enabled: not_allowed
      value: disabled
    tcp_routes_enabled: disabled
    tls_config:
      value: disabled
    vmr_agent_port: 18080
    vmr_debug_logs: disabled
  jobs:
  - name: docker
    release: docker
    consumes: {}
  - name: prepare_vmr
    release: solace-vmr
    consumes: {}
  - name: containers
    release: solace-vmr
    consumes: {}
    provides:
      vmr_instance: { as: community_vmr_list }
  - name: vmr_agent
    release: solace-vmr
    consumes: {}
  - name: route_registrar
    release: solace-vmr
    consumes:
      nats_link:
        from: nats
        deployment: ((cf_deployment))
  - name: route_registrar_active
    release: solace-vmr
    consumes:
      nats_link:
        from: nats
        deployment: ((cf_deployment))
- name: Large-HA-VMR
  stemcell: default
  instances: 0
  vm_type: solace.large
  azs:
  - z1
  - z2
  - z3
  networks:
  - name: default
  persistent_disk: 40960
  jobs:
  - name: docker
    release: docker
    consumes: {}
  - name: prepare_vmr
    release: solace-vmr
    consumes: {}
  - name: containers
    release: solace-vmr
    consumes: {}
    provides:
      vmr_instance: { as: large_ha_vmr_list }
  - name: vmr_agent
    release: solace-vmr
    consumes: {}
  - name: route_registrar
    release: solace-vmr
    consumes:
      nats_link:
        from: nats
        deployment: ((cf_deployment))
  - name: route_registrar_active
    release: solace-vmr
    consumes:
      nats_link:
        from: nats
        deployment: ((cf_deployment))
  properties:
    admin_password: ((vmr_admin_password))
    admin_user: admin
    application_access_auth_scheme:
      value: vmr_internal
    broker_hostname: solace-messaging.((app_domain))
    broker_password: ((solace_broker_password))
    broker_user: ((solace_broker_user))
    cf_api_host: api.((system_domain))
    cf_client_id: ((solace_router_client_id))
    cf_client_secret: ((solace_router_client_secret))
    cf_organization: ((solace_broker_cf_organization))
    cf_space: ((solace_broker_cf_space))
    containers:
    - dockerfile: |2-
                  FROM solace-app:latest

                  RUN \
                    echo '#!/bin/bash' > /sbin/dhclient && \
                    echo 'exit 0' >> /sbin/dhclient && \
                    echo '3a:40:d5:42:f4:86' > /usr/sw/.nodeIdentifyingMacAddr && \
                    chmod +x /sbin/dhclient
      env_vars:
      - NODE_TYPE=MESSAGE_ROUTING_NODE
      - SERVICE_SSH_PORT=2222
      - SYSTEM_SCALING_MAXCONNECTIONCOUNT=10000
      - USERNAME_ADMIN_GLOBALACCESSLEVEL=admin
      - USERNAME_ADMIN_PASSWORD=((vmr_admin_password))
      image: solace-bosh
      name: solace
      net: host
      privileged: true
      shm_size: 2G
      uts: host
      volumes:
      - /var/vcap/store/prepare_vmr/volumes/jail:/usr/sw/jail
      - /var/vcap/store/prepare_vmr/volumes/var:/usr/sw/var
      - /var/vcap/store/prepare_vmr/volumes/internalSpool:/usr/sw/internalSpool
      - /var/vcap/store/prepare_vmr/volumes/adbBackup:/usr/sw/adb
      - /var/vcap/store/prepare_vmr/volumes/adb:/usr/sw/internalSpool/softAdb
    edition: ((vmr_edition))
    heartbeat_rate: 15000
    ldap_config:
      value: disabled
    management_access_auth_scheme:
      value: vmr_internal
    pool_name: Large-HA-VMR
    plan:
      limit:
        maxVpns: 1
        credentialsPerVpn: 500
        maxConnections: 1000
        maxRestConnections: 1000
        maxSubscriptions: 500000
        maxTransactedSessions: 1000
        maxTransactions: 5000
        maxEndpoints: 1000
    semp_port: 8080
    semp_ssl_port: 943
    ssh_port: 2222
    starting_port: ((starting_port))
    syslog_config:
      value: disabled
    system_domain: ((system_domain))
    tcp_routes_config:
      selected_option:
        tcp_route_enabled: not_allowed
      value: disabled
    tcp_routes_enabled: disabled
    tls_config:
      value: disabled
    vmr_agent_port: 18080
    vmr_debug_logs: disabled
- name: Large-VMR
  stemcell: default
  instances: 0
  vm_type: solace.large
  azs:
  - z1
  - z2
  - z3
  networks:
  - name: default
  persistent_disk: 40960
  jobs:
  - name: docker
    release: docker
    consumes: {}
  - name: prepare_vmr
    release: solace-vmr
    consumes: {}
  - name: containers
    release: solace-vmr
    consumes: {}
    provides:
      vmr_instance: { as: large_vmr_list }
  - name: vmr_agent
    release: solace-vmr
    consumes: {}
  - name: route_registrar
    release: solace-vmr
    consumes:
      nats_link:
        from: nats
        deployment: ((cf_deployment))
  - name: route_registrar_active
    release: solace-vmr
    consumes:
      nats_link:
        from: nats
        deployment: ((cf_deployment))
  properties:
    admin_password: ((vmr_admin_password))
    admin_user: admin
    application_access_auth_scheme:
      value: vmr_internal
    broker_hostname: solace-messaging.((app_domain))
    broker_password: ((solace_broker_password))
    broker_user: ((solace_broker_user))
    cf_api_host: api.((system_domain))
    cf_client_id: ((solace_router_client_id))
    cf_client_secret: ((solace_router_client_secret))
    cf_organization: ((solace_broker_cf_organization))
    cf_space: ((solace_broker_cf_space))
    containers:
    - dockerfile: |2-
                  FROM solace-app:latest

                  RUN \
                    echo '#!/bin/bash' > /sbin/dhclient && \
                    echo 'exit 0' >> /sbin/dhclient && \
                    echo '3a:40:d5:42:f4:86' > /usr/sw/.nodeIdentifyingMacAddr && \
                    chmod +x /sbin/dhclient
      env_vars:
      - NODE_TYPE=MESSAGE_ROUTING_NODE
      - SERVICE_SSH_PORT=2222
      - SYSTEM_SCALING_MAXCONNECTIONCOUNT=10000
      - USERNAME_ADMIN_GLOBALACCESSLEVEL=admin
      - USERNAME_ADMIN_PASSWORD=((vmr_admin_password))
      image: solace-bosh
      name: solace
      net: host
      privileged: true
      shm_size: 2G
      uts: host
      volumes:
      - /var/vcap/store/prepare_vmr/volumes/jail:/usr/sw/jail
      - /var/vcap/store/prepare_vmr/volumes/var:/usr/sw/var
      - /var/vcap/store/prepare_vmr/volumes/internalSpool:/usr/sw/internalSpool
      - /var/vcap/store/prepare_vmr/volumes/adbBackup:/usr/sw/adb
      - /var/vcap/store/prepare_vmr/volumes/adb:/usr/sw/internalSpool/softAdb
    edition: ((vmr_edition))
    heartbeat_rate: 15000
    ldap_config:
      value: disabled
    management_access_auth_scheme:
      value: vmr_internal
    pool_name: Large-VMR
    plan:
      limit:
        maxVpns: 1
        credentialsPerVpn: 500
        maxConnections: 1000
        maxRestConnections: 1000
        maxSubscriptions: 500000
        maxTransactedSessions: 1000
        maxTransactions: 5000
        maxEndpoints: 1000
    semp_port: 8080
    semp_ssl_port: 943
    ssh_port: 2222
    starting_port: ((starting_port))
    syslog_config:
      value: disabled
    system_domain: ((system_domain))
    tcp_routes_config:
      selected_option:
        tcp_route_enabled: not_allowed
      value: disabled
    tcp_routes_enabled: disabled
    tls_config:
      value: disabled
    vmr_agent_port: 18080
    vmr_debug_logs: disabled
- name: Medium-HA-VMR
  stemcell: default
  instances: 0
  vm_type: solace.medium
  azs:
  - z1
  - z2
  - z3
  networks:
  - name: default
  persistent_disk: 20480
  jobs:
  - name: docker
    release: docker
    consumes: {}
  - name: prepare_vmr
    release: solace-vmr
    consumes: {}
  - name: containers
    release: solace-vmr
    consumes: {}
    provides:
      vmr_instance: { as: medium_ha_vmr_list }
  - name: vmr_agent
    release: solace-vmr
    consumes: {}
  - name: route_registrar
    release: solace-vmr
    consumes:
      nats_link:
        from: nats
        deployment: ((cf_deployment))
  - name: route_registrar_active
    release: solace-vmr
    consumes:
      nats_link:
        from: nats
        deployment: ((cf_deployment))
  properties:
    admin_password: ((vmr_admin_password))
    admin_user: admin
    application_access_auth_scheme:
      value: vmr_internal
    broker_hostname: solace-messaging.((app_domain))
    broker_password: ((solace_broker_password))
    broker_user: ((solace_broker_user))
    cf_api_host: api.((system_domain))
    cf_client_id: ((solace_router_client_id))
    cf_client_secret: ((solace_router_client_secret))
    cf_organization: ((solace_broker_cf_organization))
    cf_space: ((solace_broker_cf_space))
    containers:
    - dockerfile: |2-
                  FROM solace-app:latest

                  RUN \
                    echo '#!/bin/bash' > /sbin/dhclient && \
                    echo 'exit 0' >> /sbin/dhclient && \
                    echo '3a:40:d5:42:f4:86' > /usr/sw/.nodeIdentifyingMacAddr && \
                    chmod +x /sbin/dhclient
      env_vars:
      - NODE_TYPE=MESSAGE_ROUTING_NODE
      - SERVICE_SSH_PORT=2222
      - SYSTEM_SCALING_MAXCONNECTIONCOUNT=1000
      - USERNAME_ADMIN_GLOBALACCESSLEVEL=admin
      - USERNAME_ADMIN_PASSWORD=((vmr_admin_password))
      image: solace-bosh
      name: solace
      net: host
      privileged: true
      shm_size: 2G
      uts: host
      volumes:
      - /var/vcap/store/prepare_vmr/volumes/jail:/usr/sw/jail
      - /var/vcap/store/prepare_vmr/volumes/var:/usr/sw/var
      - /var/vcap/store/prepare_vmr/volumes/internalSpool:/usr/sw/internalSpool
      - /var/vcap/store/prepare_vmr/volumes/adbBackup:/usr/sw/adb
      - /var/vcap/store/prepare_vmr/volumes/adb:/usr/sw/internalSpool/softAdb
    edition: ((vmr_edition))
    heartbeat_rate: 15000
    ldap_config:
      value: disabled
    management_access_auth_scheme:
      value: vmr_internal
    pool_name: Medium-HA-VMR
    plan:
      limit:
        maxVpns: 1
        credentialsPerVpn: 500
        maxConnections: 1000
        maxRestConnections: 1000
        maxSubscriptions: 500000
        maxTransactedSessions: 1000
        maxTransactions: 5000
        maxEndpoints: 1000
    semp_port: 8080
    semp_ssl_port: 943
    ssh_port: 2222
    starting_port: ((starting_port))
    syslog_config:
      value: disabled
    system_domain: ((system_domain))
    tcp_routes_config:
      selected_option:
        tcp_route_enabled: not_allowed
      value: disabled
    tcp_routes_enabled: disabled
    tls_config:
      value: disabled
    vmr_agent_port: 18080
    vmr_debug_logs: disabled
- name: deploy-all
  jobs:
  - name: deploy-all
    release: solace-messaging
    provides: {}
    consumes:
      solace_vmr_shared_vmr: { from: shared_vmr_list }
      solace_vmr_community_vmr: { from: community_vmr_list }
      solace_vmr_large_vmr: { from: large_vmr_list }
      solace_vmr_medium_ha_vmr: { from: medium_ha_vmr_list }
      solace_vmr_large_ha_vmr: { from: large_ha_vmr_list }
  instances: 1
  vm_type: minimal
  stemcell: default
  lifecycle: errand
  azs:
  - z1
  networks:
  - name: default
  properties:
    apply_open_security_group: true
    app_domains:
    - ((app_domain))
    application_access_auth_scheme:
      value: vmr_internal
    cf:
      admin_password: ((cf_admin_password))
      admin_user: admin
    domain: ((system_domain))
    ldap_config:
      value: disabled
    management_access_auth_scheme:
      value: vmr_internal
    org: ((solace_broker_cf_organization))
    security:
      password: ((solace_broker_password))
      user: ((solace_broker_user))
    solace_messaging:
      app_manifest:
        buildpack: java_buildpack
        env:
          IS_ENTERPRISE_MODE: '((is_enterprise_mode))'
          JBP_CONFIG_CONTAINER_CERTIFICATE_TRUST_STORE: '{enabled: true}'
          SOLACE_LOAD_VERSION: ((solace_load_version))
          SOLACE_ROUTER_CLIENT_ID: ((solace_router_client_id))
          SOLACE_ROUTER_CLIENT_SECRET: ((solace_router_client_secret))
        memory: 1024M
        path: ((solace_service_broker_jar))
        health-check-http-endpoint: /health
        health-check-type: http
        timeout: 180
      auto_services:
      - name: p-mysql
        plan: ((mysql_plan))
      enable_global_access_to_plans: ((enable_global_access_to_plans))
      password: ((solace_broker_password))
      user: ((solace_broker_user))
    space: ((solace_broker_cf_space))
    ssl:
      skip_cert_verify: true
    starting_port: ((starting_port))
    syslog_config:
      value: disabled
    tcp_routes_config:
      selected_option:
        tcp_route_enabled: not_allowed
      value: disabled
    tls_config:
      value: disabled
    vmr_admin_password: ((vmr_admin_password))
- name: tests
  jobs:
  - name: tests
    release: solace-vmr
    provides: {}
    consumes:
      solace_vmr_shared_vmr: { from: shared_vmr_list }
      solace_vmr_community_vmr: { from: community_vmr_list }
      solace_vmr_large_vmr: { from: large_vmr_list }
      solace_vmr_medium_ha_vmr: { from: medium_ha_vmr_list }
      solace_vmr_large_ha_vmr: { from: large_ha_vmr_list }
  instances: 1
  vm_type: minimal
  stemcell: default
  lifecycle: errand
  azs:
  - z1
  networks:
  - name: default
  properties:
    apply_open_security_group: true
    app_domains:
    - ((app_domain))
    application_access_auth_scheme:
      value: vmr_internal
    broker_hostname: solace-messaging.((app_domain))
    broker_password: ((solace_broker_password))
    broker_user: ((solace_broker_user))
    cf:
      admin_password: ((cf_admin_password))
      admin_user: admin
    domain: ((system_domain))
    ldap_config:
      value: disabled
    management_access_auth_scheme:
      value: vmr_internal
    org: ((solace_broker_cf_organization))
    security:
      password: ((solace_broker_password))
      user: ((solace_broker_user))
    solace_messaging:
      app_manifest:
        buildpack: java_buildpack
        env:
          IS_ENTERPRISE_MODE: '((is_enterprise_mode))'
          JBP_CONFIG_CONTAINER_CERTIFICATE_TRUST_STORE: '{enabled: true}'
          SOLACE_LOAD_VERSION: ((solace_load_version))
          SOLACE_ROUTER_CLIENT_ID: ((solace_router_client_id))
          SOLACE_ROUTER_CLIENT_SECRET: ((solace_router_client_secret))
        memory: 1024M
        path: ((solace_service_broker_jar))
        health-check-http-endpoint: /health
        health-check-type: http
        timeout: 180
      auto_services:
      - name: p-mysql
        plan: ((mysql_plan))
      enable_global_access_to_plans: ((enable_global_access_to_plans))
      password: ((solace_broker_password))
      user: ((solace_broker_user))
    space: ((solace_broker_cf_space))
    ssl:
      skip_cert_verify: true
    starting_port: ((starting_port))
    syslog_config:
      value: disabled
    tcp_routes_config:
      selected_option:
        tcp_route_enabled: not_allowed
      value: disabled
    tls_config:
      value: disabled
    vmr_admin_password: ((vmr_admin_password))
- name: delete-all
  instances: 1
  vm_type: minimal
  stemcell: default
  lifecycle: errand
  azs:
  - z1
  networks:
  - name: default
  properties:
    app_domains:
    - ((app_domain))
    application_access_auth_scheme:
      value: vmr_internal
    cf:
      admin_password: ((cf_admin_password))
      admin_user: admin
    domain: ((system_domain))
    ldap_config:
      value: disabled
    management_access_auth_scheme:
      value: vmr_internal
    org: ((solace_broker_cf_organization))
    security:
      password: ((solace_broker_password))
      user: ((solace_broker_user))
    solace_messaging:
      app_manifest:
        buildpack: java_buildpack
        env:
          IS_ENTERPRISE_MODE: '((is_enterprise_mode))'
          JBP_CONFIG_CONTAINER_CERTIFICATE_TRUST_STORE: '{enabled: true}'
          SOLACE_LOAD_VERSION: ((solace_load_version))
          SOLACE_ROUTER_CLIENT_ID: ((solace_router_client_id))
          SOLACE_ROUTER_CLIENT_SECRET: ((solace_router_client_secret))
        memory: 1024M
        path: ((solace_service_broker_jar)) 
        health-check-http-endpoint: /health
        health-check-type: http
      auto_services:
      - name: p-mysql
        plan: ((mysql_plan))
      enable_global_access_to_plans: ((enable_global_access_to_plans))
      password: ((solace_broker_password))
      user: ((solace_broker_user))
    space: ((solace_broker_cf_space))
    ssl:
      skip_cert_verify: true
    starting_port: ((starting_port))
    syslog_config:
      value: disabled
    tcp_routes_config:
      selected_option:
        tcp_route_enabled: not_allowed
      value: disabled
    tls_config:
      value: disabled
    vmr_admin_password: ((vmr_admin_password))
  jobs:
  - name: delete-all
    release: solace-messaging
    consumes:
      solace_vmr_shared_vmr: { from: shared_vmr_list }
      solace_vmr_community_vmr: { from: community_vmr_list }
      solace_vmr_large_vmr: { from: large_vmr_list }
      solace_vmr_medium_ha_vmr: { from: medium_ha_vmr_list }
      solace_vmr_large_ha_vmr: { from: large_ha_vmr_list }
- name: broker
  instances: 1
  vm_type: default
  stemcell: default
  networks: [{name: default}]
  azs: [z1]
  jobs:
    - name: register-broker
      release: ((od_broker_release))
      properties:
        broker_name: ((od_broker_name))
        broker_uri: https://((od_broker_name)).((system_domain))
        disable_ssl_cert_verification: ((disable_ssl_cert_verification))
        cf:
          api_url: api.((system_domain))
          admin_username: admin
          admin_password: ((cf_admin_password))
    - name: deregister-broker
      release: ((od_broker_release))
      properties:
        broker_name: ((od_broker_name))
      jobs: []
    - name: delete-all-service-instances-and-deregister-broker
      release: ((od_broker_release))
      properties:
        broker_name: ((od_broker_name))
        polling_interval_seconds: 10 # matches broker_client_default_async_poll_interval_seconds in cf manifest
      jobs: []
    - name: delete-all-service-instances
      release: ((od_broker_release))
      properties:
        polling_interval_seconds: 10 # matches broker_client_default_async_poll_interval_seconds in cf manifest
      jobs: []
    - name: upgrade-all-service-instances
      release: ((od_broker_release))
      properties:
        max_in_flight: 1
        polling_interval_seconds: 10
        canaries: 1
      jobs: []
    - name: orphan-deployments
      release: ((od_broker_release))
      properties: {}
      jobs: []
    - name: broker
      release: ((od_broker_release))
      properties:
        expose_operational_errors: false
        startup_banner: true
        port: ((od_broker_port))
        username: broker
        password: ((od_broker_password))
        shutdown_timeout_in_seconds: 10
        bosh:
          url: ((bosh_url))
          authentication:
            uaa:
              client_id: ((bosh_authentication_username))
              client_secret: ((bosh_authentication_password))
          root_ca_cert: ((bosh_root_ca_cert))
        cf:
          root_ca_cert: ((router_ca.ca))
          url: https://api.((system_domain))
          authentication:
            url: https://uaa.((system_domain))
            user_credentials:
              username: admin
              password: ((cf_admin_password))
        service_deployment:
          releases:
          - name: *solace_vmr_release_name
            version: ((solace_vmr_release_version))
            jobs: [ vmr_agent, prepare_vmr, containers , route_registrar , route_registrar_active ]
          - name: docker
            version: ((docker_release_version))
            jobs: [ docker ]
          stemcell:
            os: ubuntu-trusty
            version: ((bosh_stemcell_version))
        service_catalog:
          id: ((service_catalog_id))
          service_name: ((service_catalog_service_name))
          service_description: Service Description
          bindable: true
          plan_updatable: true
          metadata:
            display_name: Service Broker
          tags:
            - pivotal
          global_properties:
            persistence: true
          plans: []
    - name: route_registrar
      release: routing
      consumes:
        nats:
          from: nats
          deployment: ((cf_deployment))
      properties:
        route_registrar:
          routes:
          - name: ((od_broker_route_name))
            registration_interval: 20s
            port: ((od_broker_port))
            uris: [((od_broker_name)).((system_domain))]
    - name: consul_agent
      release: consul
      consumes:
        consul: nil
        consul_client:
          from: consul_client_link
          deployment: ((cf_deployment))
        consul_common:
          from: consul_common_link
          deployment: ((cf_deployment))
        consul_server: nil

variables:
- name: vmr_admin_password
  type: password
- name: solace_broker_password
  type: password
- name: solace_broker_user
  type: password
- name: solace_router_client_secret
  type: password
- name: example_ca
  type: certificate
  options: {is_ca: true, common_name: example-ca}
- name: solace_vmr_cert
  type: certificate
  options: {ca: example_ca, common_name: solace-vmr-cert, extended_key_usage: [client_auth, server_auth]}
- name: od_broker_password
  type: password
