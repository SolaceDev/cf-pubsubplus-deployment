name: solace_messaging
releases:
- name: docker
  version: latest
- name: solace-vmr
  version: latest
- name: solace-messaging
  version: latest
- name: cf-mysql
  sha1: 170ed88b80e22ef5274210269eb1adaeed15b55f
#  stemcell:
#    os: ubuntu-trusty
#    version: '3541.10'
  url: https://storage.googleapis.com/cf-deployment-compiled-releases/cf-mysql-36.12.0-ubuntu-trusty-3541.10-20180404-063922-21489785.tgz
  version: 36.12.0
- name: consul
  version: latest
#- name: routing
#  sha1: 6f15de5699cbbce8a49ac3a1a49185460ef93f95
#  url: https://bosh.io/d/github.com/cloudfoundry-incubator/cf-routing-release?v=0.154.0
#  version: 0.154.0
update:
  canaries: 1
  canary_watch_time: 30000-240000
  max_in_flight: 1
  update_watch_time: 30000-600000
  serial: true
stemcells:
- alias: default
  os: ubuntu-trusty
  version: ((bosh_stemcell_version))
instance_groups:
- name: mysql
  instances: 2
  networks:
  - name: default
  azs: [z1, z2]
  persistent_disk_type: 5GB
  update:
    serial: true
  vm_type: small
  stemcell: default
  jobs:
  - name: mysql
    release: cf-mysql
    properties:
      cf_mysql:
        mysql:
          admin_password: ((cf_mysql_mysql_admin_password)) 
          remote_admin_access: false
          innodb_buffer_pool_size: 128M # https://github.com/cloudfoundry/cf-mysql-deployment/blob/master/operations/bosh-lite.yml
          # binlog_enabled: false
          cluster_health:
            password: ((cf_mysql_mysql_cluster_health_password))
          galera_healthcheck:
            db_password: ((cf_mysql_mysql_galera_healthcheck_db_password))
            endpoint_password: ((cf_mysql_mysql_galera_healthcheck_endpoint_password))
            # endpoint_username: galera_healthcheck
          port: 3306
          seeded_databases:
          - name: service_broker 
            username: service_broker
            password: ((cf_mysql_mysql_seeded_databases_service_broker_password))
  - name: smoke-tests-user
    release: cf-mysql
    properties:
      cf_mysql:
        smoke_tests:
          db_password: ((cf_mysql_smoke_tests_db_password))

- name: arbitrator
  instances: 1
  azs: [z3]
  networks: [{name: default}]
  vm_type: default
  stemcell: default
  jobs:
  - release: cf-mysql
    name: arbitrator
    properties:
      cf_mysql:
        mysql:
          admin_password: ((cf_mysql_mysql_admin_password))
          galera_healthcheck:
            endpoint_password: ((cf_mysql_mysql_galera_healthcheck_endpoint_password))

- name: proxy
  instances: 2
  azs: [z1, z2]
  networks: [{name: default}]
  vm_type: default
  stemcell: default
  jobs:
  - name: proxy
    release: cf-mysql
    properties:
      cf_mysql:
        proxy:
          api_password: ((cf_mysql_proxy_api_password))
          consul_enabled: true
          consul_service_name: mysql
    provides:
      proxy:
        as: mysql-proxy
        shared: true
  - name: consul_agent
    release: consul
    consumes: 
      consul_common: {from: consul_common_link, deployment: ((cf_deployment))}
      consul_server: {from: consul_server_link, deployment: ((cf_deployment))}
      consul_client: {from: consul_client_link, deployment: ((cf_deployment))}

- name: bootstrap-vm
  instances: 1
  lifecycle: errand
  azs: [z1]
  networks: [{name: default}]
  vm_type: default
  stemcell: default
  jobs:
  - {release: cf-mysql, name: bootstrap}

- name: rejoin-unsafe-vm
  instances: 1
  lifecycle: errand
  azs: [z1]
  networks: [{name: default}]
  vm_type: default
  stemcell: default
  jobs:
  - {release: cf-mysql, name: rejoin-unsafe}

- name: verify-cluster-schemas-vm
  instances: 1
  lifecycle: errand
  azs: [z1]
  networks: [{name: default}]
  vm_type: default
  stemcell: default
  jobs:
  - name: verify-cluster-schemas
    release: cf-mysql
    properties:
      cf_mysql:
        mysql:
          admin_password: ((cf_mysql_mysql_admin_password))
          galera_healthcheck:
            endpoint_password: ((cf_mysql_mysql_galera_healthcheck_endpoint_password))

- name: smoke-tests-vm
  instances: 1
  lifecycle: errand
  azs: [z1]
  networks: [{name: default}]
  vm_type: default
  stemcell: default
  jobs:
  - name: smoke-tests
    release: cf-mysql
    properties:
      cf_mysql:
        mysql:
          admin_password: ((cf_mysql_mysql_admin_password))
        proxy:
          api_password: ((cf_mysql_proxy_api_password))
        smoke_tests:
          db_password: ((cf_mysql_smoke_tests_db_password))
          standalone_tests_only: true

- name: Shared-VMR
  stemcell: default
  instances: 0
  vm_type: solace.medium
  azs:
  - z1
  - z2
  - z3
  networks:
  - name: default
  persistent_disk: 20480
  jobs:
  - name: docker
    release: docker
    consumes: {}
  - name: prepare_vmr
    release: solace-vmr
    consumes: {}
  - name: containers
    release: solace-vmr
    consumes: {}
    provides:
      vmr_instance: { as: shared_vmr_list }
  - name: vmr_agent
    release: solace-vmr
    consumes: {}
  - name: route_registrar
    release: solace-vmr
    consumes:
      nats_link:
        from: nats
        deployment: ((cf_deployment))
  - name: route_registrar_active
    release: solace-vmr
    consumes:
      nats_link:
        from: nats
        deployment: ((cf_deployment))
  properties:
    admin_password: ((vmr_admin_password))
    admin_user: admin
    application_access_auth_scheme:
      value: vmr_internal
    broker_hostname: solace-messaging.((app_domain))
    broker_password: ((solace_broker_password))
    broker_user: ((solace_broker_user))
    cf_api_host: api.((system_domain))
    cf_client_id: ((solace_router_client_id))
    cf_client_secret: ((solace_router_client_secret))
    cf_organization: ((solace_broker_cf_organization))
    cf_space: ((solace_broker_cf_space))
    containers:
    - dockerfile: |2-
                  FROM solace-app:latest

                  RUN \
                    echo '#!/bin/bash' > /sbin/dhclient && \
                    echo 'exit 0' >> /sbin/dhclient && \
                    echo '3a:40:d5:42:f4:86' > /usr/sw/.nodeIdentifyingMacAddr && \
                    chmod +x /sbin/dhclient
      env_vars:
      - NODE_TYPE=MESSAGE_ROUTING_NODE
      - SERVICE_SSH_PORT=2222
      - SYSTEM_SCALING_MAXCONNECTIONCOUNT=1000
      - USERNAME_ADMIN_GLOBALACCESSLEVEL=admin
      - USERNAME_ADMIN_PASSWORD=((vmr_admin_password))
      image: solace-bosh
      name: solace
      net: host
      privileged: true
      shm_size: 2G
      uts: host
      volumes:
      - /var/vcap/store/prepare_vmr/volumes/jail:/usr/sw/jail
      - /var/vcap/store/prepare_vmr/volumes/var:/usr/sw/var
      - /var/vcap/store/prepare_vmr/volumes/internalSpool:/usr/sw/internalSpool
      - /var/vcap/store/prepare_vmr/volumes/adbBackup:/usr/sw/adb
      - /var/vcap/store/prepare_vmr/volumes/adb:/usr/sw/internalSpool/softAdb
    edition: ((vmr_edition))
    heartbeat_rate: 15000
    ldap_config:
      value: disabled
    management_access_auth_scheme:
      value: vmr_internal
    pool_name: Shared-VMR
    plan:
      limit:
        maxVpns: 5
        credentialsPerVpn: 100
        maxConnections: 200
        maxRestConnections: 200
        maxSubscriptions: 100000
        maxTransactedSessions: 200
        maxTransactions: 1000
        maxEndpoints: 200
    semp_port: 8080
    semp_ssl_port: 943
    ssh_port: 2222
    starting_port: ((starting_port))
    syslog_config:
      value: disabled
    system_domain: ((system_domain))
    tcp_routes_config:
      selected_option:
        tcp_route_enabled: not_allowed
      value: disabled
    tcp_routes_enabled: disabled
    tls_config:
      value: disabled
    vmr_agent_port: 18080
    vmr_debug_logs: disabled
- name: Community-VMR
  stemcell: default
  instances: 1
  vm_type: solace.medium
  azs:
  - z1
  - z2
  - z3
  networks:
  - name: default
  persistent_disk: 20480
  properties:
    admin_password: ((vmr_admin_password))
    admin_user: admin
    application_access_auth_scheme:
      value: vmr_internal
    broker_hostname: solace-messaging.((app_domain))
    broker_password: ((solace_broker_password))
    broker_user: ((solace_broker_user))
    cf_api_host: api.((system_domain))
    cf_client_id: ((solace_router_client_id))
    cf_client_secret: ((solace_router_client_secret))
    cf_organization: ((solace_broker_cf_organization))
    cf_space: ((solace_broker_cf_space))
    containers:
    - dockerfile: |2-
                  FROM solace-app:latest

                  RUN \
                    echo '#!/bin/bash' > /sbin/dhclient && \
                    echo 'exit 0' >> /sbin/dhclient && \
                    echo '3a:40:d5:42:f4:86' > /usr/sw/.nodeIdentifyingMacAddr && \
                    chmod +x /sbin/dhclient
      env_vars:
      - NODE_TYPE=MESSAGE_ROUTING_NODE
      - SERVICE_SSH_PORT=2222
      - SYSTEM_SCALING_MAXCONNECTIONCOUNT=100
      - USERNAME_ADMIN_GLOBALACCESSLEVEL=admin
      - USERNAME_ADMIN_PASSWORD=((vmr_admin_password))
      image: solace-bosh
      name: solace
      net: host
      privileged: true
      shm_size: 2G
      uts: host
      volumes:
      - /var/vcap/store/prepare_vmr/volumes/jail:/usr/sw/jail
      - /var/vcap/store/prepare_vmr/volumes/var:/usr/sw/var
      - /var/vcap/store/prepare_vmr/volumes/internalSpool:/usr/sw/internalSpool
      - /var/vcap/store/prepare_vmr/volumes/adbBackup:/usr/sw/adb
      - /var/vcap/store/prepare_vmr/volumes/adb:/usr/sw/internalSpool/softAdb
    edition: ((vmr_edition))
    heartbeat_rate: 15000
    ldap_config:
      value: disabled
    management_access_auth_scheme:
      value: vmr_internal
    pool_name: Community-VMR
    plan:
      limit:
        maxVpns: 1
        credentialsPerVpn: 90
        maxConnections: 100
        maxRestConnections: 100
        maxSubscriptions: 500000
        maxTransactedSessions: 100 
        maxTransactions: 500
        maxEndpoints: 100
    semp_port: 8080
    semp_ssl_port: 943
    ssh_port: 2222
    starting_port: ((starting_port))
    syslog_config:
      value: disabled
    system_domain: ((system_domain))
    tcp_routes_config:
      selected_option:
        tcp_route_enabled: not_allowed
      value: disabled
    tcp_routes_enabled: disabled
    tls_config:
      value: disabled
    vmr_agent_port: 18080
    vmr_debug_logs: disabled
  jobs:
  - name: docker
    release: docker
    consumes: {}
  - name: prepare_vmr
    release: solace-vmr
    consumes: {}
  - name: containers
    release: solace-vmr
    consumes: {}
    provides:
      vmr_instance: { as: community_vmr_list }
  - name: vmr_agent
    release: solace-vmr
    consumes: {}
  - name: route_registrar
    release: solace-vmr
    consumes:
      nats_link:
        from: nats
        deployment: ((cf_deployment))
  - name: route_registrar_active
    release: solace-vmr
    consumes:
      nats_link:
        from: nats
        deployment: ((cf_deployment))
- name: Large-HA-VMR
  stemcell: default
  instances: 0
  vm_type: solace.large
  azs:
  - z1
  - z2
  - z3
  networks:
  - name: default
  persistent_disk: 40960
  jobs:
  - name: docker
    release: docker
    consumes: {}
  - name: prepare_vmr
    release: solace-vmr
    consumes: {}
  - name: containers
    release: solace-vmr
    consumes: {}
    provides:
      vmr_instance: { as: large_ha_vmr_list }
  - name: vmr_agent
    release: solace-vmr
    consumes: {}
  - name: route_registrar
    release: solace-vmr
    consumes:
      nats_link:
        from: nats
        deployment: ((cf_deployment))
  - name: route_registrar_active
    release: solace-vmr
    consumes:
      nats_link:
        from: nats
        deployment: ((cf_deployment))
  properties:
    admin_password: ((vmr_admin_password))
    admin_user: admin
    application_access_auth_scheme:
      value: vmr_internal
    broker_hostname: solace-messaging.((app_domain))
    broker_password: ((solace_broker_password))
    broker_user: ((solace_broker_user))
    cf_api_host: api.((system_domain))
    cf_client_id: ((solace_router_client_id))
    cf_client_secret: ((solace_router_client_secret))
    cf_organization: ((solace_broker_cf_organization))
    cf_space: ((solace_broker_cf_space))
    containers:
    - dockerfile: |2-
                  FROM solace-app:latest

                  RUN \
                    echo '#!/bin/bash' > /sbin/dhclient && \
                    echo 'exit 0' >> /sbin/dhclient && \
                    echo '3a:40:d5:42:f4:86' > /usr/sw/.nodeIdentifyingMacAddr && \
                    chmod +x /sbin/dhclient
      env_vars:
      - NODE_TYPE=MESSAGE_ROUTING_NODE
      - SERVICE_SSH_PORT=2222
      - SYSTEM_SCALING_MAXCONNECTIONCOUNT=10000
      - USERNAME_ADMIN_GLOBALACCESSLEVEL=admin
      - USERNAME_ADMIN_PASSWORD=((vmr_admin_password))
      image: solace-bosh
      name: solace
      net: host
      privileged: true
      shm_size: 2G
      uts: host
      volumes:
      - /var/vcap/store/prepare_vmr/volumes/jail:/usr/sw/jail
      - /var/vcap/store/prepare_vmr/volumes/var:/usr/sw/var
      - /var/vcap/store/prepare_vmr/volumes/internalSpool:/usr/sw/internalSpool
      - /var/vcap/store/prepare_vmr/volumes/adbBackup:/usr/sw/adb
      - /var/vcap/store/prepare_vmr/volumes/adb:/usr/sw/internalSpool/softAdb
    edition: ((vmr_edition))
    heartbeat_rate: 15000
    ldap_config:
      value: disabled
    management_access_auth_scheme:
      value: vmr_internal
    pool_name: Large-HA-VMR
    plan:
      limit:
        maxVpns: 1
        credentialsPerVpn: 500
        maxConnections: 1000
        maxRestConnections: 1000
        maxSubscriptions: 500000
        maxTransactedSessions: 1000
        maxTransactions: 5000
        maxEndpoints: 1000
    semp_port: 8080
    semp_ssl_port: 943
    ssh_port: 2222
    starting_port: ((starting_port))
    syslog_config:
      value: disabled
    system_domain: ((system_domain))
    tcp_routes_config:
      selected_option:
        tcp_route_enabled: not_allowed
      value: disabled
    tcp_routes_enabled: disabled
    tls_config:
      value: disabled
    vmr_agent_port: 18080
    vmr_debug_logs: disabled
- name: Large-VMR
  stemcell: default
  instances: 0
  vm_type: solace.large
  azs:
  - z1
  - z2
  - z3
  networks:
  - name: default
  persistent_disk: 40960
  jobs:
  - name: docker
    release: docker
    consumes: {}
  - name: prepare_vmr
    release: solace-vmr
    consumes: {}
  - name: containers
    release: solace-vmr
    consumes: {}
    provides:
      vmr_instance: { as: large_vmr_list }
  - name: vmr_agent
    release: solace-vmr
    consumes: {}
  - name: route_registrar
    release: solace-vmr
    consumes:
      nats_link:
        from: nats
        deployment: ((cf_deployment))
  - name: route_registrar_active
    release: solace-vmr
    consumes:
      nats_link:
        from: nats
        deployment: ((cf_deployment))
  properties:
    admin_password: ((vmr_admin_password))
    admin_user: admin
    application_access_auth_scheme:
      value: vmr_internal
    broker_hostname: solace-messaging.((app_domain))
    broker_password: ((solace_broker_password))
    broker_user: ((solace_broker_user))
    cf_api_host: api.((system_domain))
    cf_client_id: ((solace_router_client_id))
    cf_client_secret: ((solace_router_client_secret))
    cf_organization: ((solace_broker_cf_organization))
    cf_space: ((solace_broker_cf_space))
    containers:
    - dockerfile: |2-
                  FROM solace-app:latest

                  RUN \
                    echo '#!/bin/bash' > /sbin/dhclient && \
                    echo 'exit 0' >> /sbin/dhclient && \
                    echo '3a:40:d5:42:f4:86' > /usr/sw/.nodeIdentifyingMacAddr && \
                    chmod +x /sbin/dhclient
      env_vars:
      - NODE_TYPE=MESSAGE_ROUTING_NODE
      - SERVICE_SSH_PORT=2222
      - SYSTEM_SCALING_MAXCONNECTIONCOUNT=10000
      - USERNAME_ADMIN_GLOBALACCESSLEVEL=admin
      - USERNAME_ADMIN_PASSWORD=((vmr_admin_password))
      image: solace-bosh
      name: solace
      net: host
      privileged: true
      shm_size: 2G
      uts: host
      volumes:
      - /var/vcap/store/prepare_vmr/volumes/jail:/usr/sw/jail
      - /var/vcap/store/prepare_vmr/volumes/var:/usr/sw/var
      - /var/vcap/store/prepare_vmr/volumes/internalSpool:/usr/sw/internalSpool
      - /var/vcap/store/prepare_vmr/volumes/adbBackup:/usr/sw/adb
      - /var/vcap/store/prepare_vmr/volumes/adb:/usr/sw/internalSpool/softAdb
    edition: ((vmr_edition))
    heartbeat_rate: 15000
    ldap_config:
      value: disabled
    management_access_auth_scheme:
      value: vmr_internal
    pool_name: Large-VMR
    plan:
      limit:
        maxVpns: 1
        credentialsPerVpn: 500
        maxConnections: 1000
        maxRestConnections: 1000
        maxSubscriptions: 500000
        maxTransactedSessions: 1000
        maxTransactions: 5000
        maxEndpoints: 1000
    semp_port: 8080
    semp_ssl_port: 943
    ssh_port: 2222
    starting_port: ((starting_port))
    syslog_config:
      value: disabled
    system_domain: ((system_domain))
    tcp_routes_config:
      selected_option:
        tcp_route_enabled: not_allowed
      value: disabled
    tcp_routes_enabled: disabled
    tls_config:
      value: disabled
    vmr_agent_port: 18080
    vmr_debug_logs: disabled
- name: Medium-HA-VMR
  stemcell: default
  instances: 0
  vm_type: solace.medium
  azs:
  - z1
  - z2
  - z3
  networks:
  - name: default
  persistent_disk: 20480
  jobs:
  - name: docker
    release: docker
    consumes: {}
  - name: prepare_vmr
    release: solace-vmr
    consumes: {}
  - name: containers
    release: solace-vmr
    consumes: {}
    provides:
      vmr_instance: { as: medium_ha_vmr_list }
  - name: vmr_agent
    release: solace-vmr
    consumes: {}
  - name: route_registrar
    release: solace-vmr
    consumes:
      nats_link:
        from: nats
        deployment: ((cf_deployment))
  - name: route_registrar_active
    release: solace-vmr
    consumes:
      nats_link:
        from: nats
        deployment: ((cf_deployment))
  properties:
    admin_password: ((vmr_admin_password))
    admin_user: admin
    application_access_auth_scheme:
      value: vmr_internal
    broker_hostname: solace-messaging.((app_domain))
    broker_password: ((solace_broker_password))
    broker_user: ((solace_broker_user))
    cf_api_host: api.((system_domain))
    cf_client_id: ((solace_router_client_id))
    cf_client_secret: ((solace_router_client_secret))
    cf_organization: ((solace_broker_cf_organization))
    cf_space: ((solace_broker_cf_space))
    containers:
    - dockerfile: |2-
                  FROM solace-app:latest

                  RUN \
                    echo '#!/bin/bash' > /sbin/dhclient && \
                    echo 'exit 0' >> /sbin/dhclient && \
                    echo '3a:40:d5:42:f4:86' > /usr/sw/.nodeIdentifyingMacAddr && \
                    chmod +x /sbin/dhclient
      env_vars:
      - NODE_TYPE=MESSAGE_ROUTING_NODE
      - SERVICE_SSH_PORT=2222
      - SYSTEM_SCALING_MAXCONNECTIONCOUNT=1000
      - USERNAME_ADMIN_GLOBALACCESSLEVEL=admin
      - USERNAME_ADMIN_PASSWORD=((vmr_admin_password))
      image: solace-bosh
      name: solace
      net: host
      privileged: true
      shm_size: 2G
      uts: host
      volumes:
      - /var/vcap/store/prepare_vmr/volumes/jail:/usr/sw/jail
      - /var/vcap/store/prepare_vmr/volumes/var:/usr/sw/var
      - /var/vcap/store/prepare_vmr/volumes/internalSpool:/usr/sw/internalSpool
      - /var/vcap/store/prepare_vmr/volumes/adbBackup:/usr/sw/adb
      - /var/vcap/store/prepare_vmr/volumes/adb:/usr/sw/internalSpool/softAdb
    edition: ((vmr_edition))
    heartbeat_rate: 15000
    ldap_config:
      value: disabled
    management_access_auth_scheme:
      value: vmr_internal
    pool_name: Medium-HA-VMR
    plan:
      limit:
        maxVpns: 1
        credentialsPerVpn: 500
        maxConnections: 1000
        maxRestConnections: 1000
        maxSubscriptions: 500000
        maxTransactedSessions: 1000
        maxTransactions: 5000
        maxEndpoints: 1000
    semp_port: 8080
    semp_ssl_port: 943
    ssh_port: 2222
    starting_port: ((starting_port))
    syslog_config:
      value: disabled
    system_domain: ((system_domain))
    tcp_routes_config:
      selected_option:
        tcp_route_enabled: not_allowed
      value: disabled
    tcp_routes_enabled: disabled
    tls_config:
      value: disabled
    vmr_agent_port: 18080
    vmr_debug_logs: disabled
- name: deploy-all
  jobs:
  - name: deploy-all
    release: solace-messaging
    provides: {}
    consumes:
      solace_vmr_shared_vmr: { from: shared_vmr_list }
      solace_vmr_community_vmr: { from: community_vmr_list }
      solace_vmr_large_vmr: { from: large_vmr_list }
      solace_vmr_medium_ha_vmr: { from: medium_ha_vmr_list }
      solace_vmr_large_ha_vmr: { from: large_ha_vmr_list }
      database_connection: { from: mysql-proxy }
  instances: 1
  vm_type: minimal
  stemcell: default
  lifecycle: errand
  azs:
  - z1
  networks:
  - name: default
  properties:
    apply_open_security_group: true
    app_domains:
    - ((app_domain))
    application_access_auth_scheme:
      value: vmr_internal
    cf:
      admin_password: ((cf_admin_password))
      admin_user: admin
    domain: ((system_domain))
    ldap_config:
      value: disabled
    management_access_auth_scheme:
      value: vmr_internal
    org: ((solace_broker_cf_organization))
    security:
      password: ((solace_broker_password))
      user: ((solace_broker_user))
    mysql:
      user: service_broker
      password: ((mysql_password))
    solace_messaging:
      app_manifest:
        buildpack: java_buildpack
        env:
          IS_ENTERPRISE_MODE: '((is_enterprise_mode))'
          JBP_CONFIG_CONTAINER_CERTIFICATE_TRUST_STORE: '{enabled: true}'
          SOLACE_LOAD_VERSION: ((solace_load_version))
          SOLACE_ROUTER_CLIENT_ID: ((solace_router_client_id))
          SOLACE_ROUTER_CLIENT_SECRET: ((solace_router_client_secret))
        memory: 1024M
        path: ((solace_service_broker_jar))
        health-check-http-endpoint: /health
        health-check-type: http
        timeout: 180
      auto_services:
      - name: p-mysql
        plan: ((mysql_plan))
      enable_global_access_to_plans: ((enable_global_access_to_plans))
      password: ((solace_broker_password))
      user: ((solace_broker_user))
    space: ((solace_broker_cf_space))
    ssl:
      skip_cert_verify: true
    starting_port: ((starting_port))
    syslog_config:
      value: disabled
    tcp_routes_config:
      selected_option:
        tcp_route_enabled: not_allowed
      value: disabled
    tls_config:
      value: disabled
    vmr_admin_password: ((vmr_admin_password))
- name: tests
  jobs:
  - name: tests
    release: solace-vmr
    provides: {}
    consumes:
      solace_vmr_shared_vmr: { from: shared_vmr_list }
      solace_vmr_community_vmr: { from: community_vmr_list }
      solace_vmr_large_vmr: { from: large_vmr_list }
      solace_vmr_medium_ha_vmr: { from: medium_ha_vmr_list }
      solace_vmr_large_ha_vmr: { from: large_ha_vmr_list }
  instances: 1
  vm_type: minimal
  stemcell: default
  lifecycle: errand
  azs:
  - z1
  networks:
  - name: default
  properties:
    apply_open_security_group: true
    app_domains:
    - ((app_domain))
    application_access_auth_scheme:
      value: vmr_internal
    broker_hostname: solace-messaging.((app_domain))
    broker_password: ((solace_broker_password))
    broker_user: ((solace_broker_user))
    cf:
      admin_password: ((cf_admin_password))
      admin_user: admin
    domain: ((system_domain))
    ldap_config:
      value: disabled
    management_access_auth_scheme:
      value: vmr_internal
    org: ((solace_broker_cf_organization))
    security:
      password: ((solace_broker_password))
      user: ((solace_broker_user))
    solace_messaging:
      app_manifest:
        buildpack: java_buildpack
        env:
          IS_ENTERPRISE_MODE: '((is_enterprise_mode))'
          JBP_CONFIG_CONTAINER_CERTIFICATE_TRUST_STORE: '{enabled: true}'
          SOLACE_LOAD_VERSION: ((solace_load_version))
          SOLACE_ROUTER_CLIENT_ID: ((solace_router_client_id))
          SOLACE_ROUTER_CLIENT_SECRET: ((solace_router_client_secret))
        memory: 1024M
        path: ((solace_service_broker_jar))
        health-check-http-endpoint: /health
        health-check-type: http
        timeout: 180
      auto_services:
      - name: p-mysql
        plan: ((mysql_plan))
      enable_global_access_to_plans: ((enable_global_access_to_plans))
      password: ((solace_broker_password))
      user: ((solace_broker_user))
    space: ((solace_broker_cf_space))
    ssl:
      skip_cert_verify: true
    starting_port: ((starting_port))
    syslog_config:
      value: disabled
    tcp_routes_config:
      selected_option:
        tcp_route_enabled: not_allowed
      value: disabled
    tls_config:
      value: disabled
    vmr_admin_password: ((vmr_admin_password))
- name: delete-all
  instances: 1
  vm_type: minimal
  stemcell: default
  lifecycle: errand
  azs:
  - z1
  networks:
  - name: default
  properties:
    app_domains:
    - ((app_domain))
    application_access_auth_scheme:
      value: vmr_internal
    cf:
      admin_password: ((cf_admin_password))
      admin_user: admin
    domain: ((system_domain))
    ldap_config:
      value: disabled
    management_access_auth_scheme:
      value: vmr_internal
    org: ((solace_broker_cf_organization))
    security:
      password: ((solace_broker_password))
      user: ((solace_broker_user))
    solace_messaging:
      app_manifest:
        buildpack: java_buildpack
        env:
          IS_ENTERPRISE_MODE: '((is_enterprise_mode))'
          JBP_CONFIG_CONTAINER_CERTIFICATE_TRUST_STORE: '{enabled: true}'
          SOLACE_LOAD_VERSION: ((solace_load_version))
          SOLACE_ROUTER_CLIENT_ID: ((solace_router_client_id))
          SOLACE_ROUTER_CLIENT_SECRET: ((solace_router_client_secret))
        memory: 1024M
        path: ((solace_service_broker_jar)) 
        health-check-http-endpoint: /health
        health-check-type: http
      auto_services:
      - name: p-mysql
        plan: ((mysql_plan))
      enable_global_access_to_plans: ((enable_global_access_to_plans))
      password: ((solace_broker_password))
      user: ((solace_broker_user))
    space: ((solace_broker_cf_space))
    ssl:
      skip_cert_verify: true
    starting_port: ((starting_port))
    syslog_config:
      value: disabled
    tcp_routes_config:
      selected_option:
        tcp_route_enabled: not_allowed
      value: disabled
    tls_config:
      value: disabled
    vmr_admin_password: ((vmr_admin_password))
  jobs:
  - name: delete-all
    release: solace-messaging
    consumes:
      solace_vmr_shared_vmr: { from: shared_vmr_list }
      solace_vmr_community_vmr: { from: community_vmr_list }
      solace_vmr_large_vmr: { from: large_vmr_list }
      solace_vmr_medium_ha_vmr: { from: medium_ha_vmr_list }
      solace_vmr_large_ha_vmr: { from: large_ha_vmr_list }
      database_connection: { from: mysql-proxy }

variables:
- name: vmr_admin_password
  type: password
- name: solace_broker_password
  type: password
- name: solace_broker_user
  type: password
- name: solace_router_client_secret
  type: password
- name: example_ca
  type: certificate
  options: {is_ca: true, common_name: example-ca}
- name: solace_vmr_cert
  type: certificate
  options: {ca: example_ca, common_name: solace-vmr-cert, extended_key_usage: [client_auth, server_auth]}
- name: cf_mysql_mysql_admin_password
  type: password
- name: cf_mysql_mysql_cluster_health_password
  type: password
- name: cf_mysql_mysql_galera_healthcheck_endpoint_password
  type: password
- name: cf_mysql_mysql_galera_healthcheck_db_password
  type: password
- name: cf_mysql_mysql_seeded_databases_service_broker_password
  type: password
- name: cf_mysql_proxy_api_password
  type: password
- name: cf_mysql_smoke_tests_db_password
  type: password
